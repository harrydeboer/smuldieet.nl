class Recipe_weights{constructor(form){this.formName=form.attr("name");this.errors=$("#recipe_weights_error");this.weightsNumber=$(".recipe-weight").length;$("#add_recipe").on("click",this.addRecipe.bind(this));form.on("input",".recipe-title",this.recipeTitleInput.bind(this));form.on("click",".recipe-result",this.recipeSearchResultClick.bind(this));form.on("click",".remove-row",this.removeRow.bind(this));form.on("submit",this.submit.bind(this))}addRecipe(event){let selector="#"+this.formName+"_recipe_weights__name__";let html='<div class="row row-weight"><div class="col-7">'+$(selector+"_recipe_id").data("prototype")+'<div class="dropdown">'+$(selector+"_title").data("prototype")+'<div class="dropdown-menu dropdown-menu-recipe"></div></div>'+"</div>";html+='<div class="col-4">'+$(selector+"_value").data("prototype")+"</div>";html+='<div class="col-1">'+'<img src="/img/minus.png?v=1" class="remove-row" alt="minus" width="25"></div></div>';html=html.replaceAll("__name__",this.weightsNumber.toString());$("#add_foodstuff_recipe_button_row").before(html);if(this.formName==="cookbook"){let value=$('[name="'+this.formName+"[recipe_weights]["+this.weightsNumber+"][value]"+'"]');value.val(1);value.addClass("hidden-input")}this.weightsNumber=this.weightsNumber+1;event.preventDefault()}recipeTitleInput(event){let thisElement=$(event.target);let row=new this.RecipeRow(event.target);row.getRecipeId().val("");let valueInput=encodeURI(thisElement.val().toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""));let searchResults=row.getSearchResults();searchResults.html("");let url=$("#recipe_search").data("search").replace("__title__",valueInput);if(this.timeout){clearTimeout(this.timeout);this.timeout=null}this.timeout=setTimeout(()=>{$.ajax({url:url,type:"GET",success:data=>{if(valueInput!==""){searchResults.html(data)}else{searchResults.html("")}$(".recipe-result").each((index,element)=>{let id=$(element).attr("id").replace("recipe_result_","");let title=$(element).text().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(thisElement.val().toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")===title){row.getRecipeId().val(id)}})},error:()=>{searchResults.html("Er ging iets fout.")}})},1e3)}recipeSearchResultClick(event){let thisElement=$(event.target);let row=new this.RecipeRow(event.target);let id=thisElement.attr("id").replace("recipe_result_","");let title=thisElement.text();row.getTitle().val(title);row.getRecipeId().val(id)}removeRow(event){new this.RecipeRow(event.target).row.remove()}submit(event){let text="";let recipeTitles=[];$(".recipe-title").each((index,element)=>{if(recipeTitles.includes($(element).val())){text=text+"Dubbel recept.";event.preventDefault()}recipeTitles.push($(element).val())});$(".recipe-id").each((index,element)=>{let row=new this.RecipeRow(element);if($(element).val()===""){text=text+"Ongeldige recepten naam: "+row.getTitle().val()+".<br>";$("html, body").animate({scrollTop:this.errors.offset().top},1e3);event.preventDefault()}});this.errors.html(text)}RecipeRow=class{constructor(thisElement){this.row=$(thisElement).closest(".row")}getRecipeId(){return this.row.find(".recipe-id")}getTitle(){return this.row.find(".dropdown-toggle")}getSearchResults(){return this.row.find(".dropdown-menu-recipe")}}}new Recipe_weights($(".recipe-weights-form"));